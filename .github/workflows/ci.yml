name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

env:
  GO_VERSION: "1.24"
  REGISTRY: ghcr.io/nsridhar76
  IMAGE_NAME: ordersvc

jobs:
  # ---------------------------------------------------------------------------
  # Lint
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
            | sh -s -- -b "$(go env GOPATH)/bin"

      - name: make lint
        run: make lint GOARCH= GOOS=

  # ---------------------------------------------------------------------------
  # Security
  # ---------------------------------------------------------------------------
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest \
            | grep '"tag_name"' | cut -d '"' -f 4)
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz" \
            | tar xz -C /usr/local/bin gitleaks

      - name: make sec
        run: make sec GOARCH= GOOS=

      - name: make vuln
        run: make vuln GOARCH= GOOS=

      - name: make secrets
        run: make secrets

  # ---------------------------------------------------------------------------
  # Test
  # ---------------------------------------------------------------------------
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: make test
        run: make test GOARCH= GOOS= CGO_ENABLED=1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Build & Push Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: make docker
        run: make docker

      - name: make docker-push
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: make docker-push

  # ---------------------------------------------------------------------------
  # Kubernetes Lint
  # ---------------------------------------------------------------------------
  k8s:
    name: Kubernetes Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin kubeconform

      - name: make k8s-lint
        run: make k8s-lint

  # ---------------------------------------------------------------------------
  # Image Scan (Trivy)
  # ---------------------------------------------------------------------------
  scan:
    name: Image Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Rebuild image for scanning
        run: make docker

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: make scan
        run: make scan

  # ---------------------------------------------------------------------------
  # ADR Drift Check
  # ---------------------------------------------------------------------------
  drift:
    name: ADR Drift Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: make drift-check
        run: make drift-check
